<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Comp Set: {{COMP_SET_NAME}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .comp-set-title {
            color: #667eea;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .property-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .property-name {
            color: #2d3748;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .property-address {
            color: #718096;
            font-size: 0.95em;
        }

        .property-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .badge-multifamily { background: #9f7aea; color: white; }
        .badge-office { background: #48bb78; color: white; }
        .badge-retail { background: #ed8936; color: white; }
        .badge-industrial { background: #4299e1; color: white; }
        .badge-mixed { background: #ed64a6; color: white; }

        .property-details {
            margin: 20px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-label {
            color: #4a5568;
            font-weight: 600;
        }

        .detail-value {
            color: #2d3748;
        }

        .occupancy-high { color: #38a169; font-weight: bold; }
        .occupancy-medium { color: #ecc94b; font-weight: bold; }
        .occupancy-low { color: #e53e3e; font-weight: bold; }

        .amenities {
            margin: 15px 0;
        }

        .amenities-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .amenity-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .units-section {
            margin-top: 20px;
        }

        .units-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .units-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .units-table th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .units-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .units-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .units-table tr:hover {
            background: #edf2f7;
        }

        .rent-highlight {
            color: #667eea;
            font-weight: 600;
        }

        .source-document {
            margin-top: 15px;
            padding: 10px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
            font-size: 0.85em;
            color: #4a5568;
        }

        .notes {
            margin-top: 15px;
            padding: 10px;
            background: #fffbeb;
            border-left: 4px solid #ecc94b;
            font-size: 0.9em;
            color: #744210;
        }

        /* Data Not Found Warning Badge */
        .data-not-found-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ed8936;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Comp Set Management Toolbar */
        .comp-toolbar {
            background: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .comp-toolbar.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .comp-toolbar.scrolled {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toolbar-wrapper {
            max-width: calc(1400px + 40px);
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .toolbar-left {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .comp-set-name-display {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.2em;
        }

        .selection-counter {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .comp-select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            color: #2d3748;
            cursor: pointer;
            min-width: 200px;
        }

        .comp-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .comp-input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            min-width: 250px;
        }

        .comp-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comp-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .comp-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .comp-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .comp-button-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .comp-button-danger:hover {
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }

        .comp-button-secondary {
            background: #48bb78;
        }

        .server-status {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .server-status.online {
            background: #c6f6d5;
            color: #22543d;
        }

        .server-status.offline {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Property Card Checkbox */
        .property-checkbox {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .property-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Action Buttons on Cards */
        .remove-from-comp-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .remove-from-comp-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #e53e3e;
        }

        .toast.info {
            border-left: 4px solid #4299e1;
        }

        .toast-message {
            flex: 1;
            color: #2d3748;
            font-size: 0.95em;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease;
        }

        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .confirmation-dialog.show {
            display: flex;
        }

        .dialog-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .dialog-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .dialog-message {
            color: #4a5568;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .dialog-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .dialog-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dialog-button-cancel {
            background: #e2e8f0;
            color: #2d3748;
        }

        .dialog-button-confirm {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .dialog-button:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .properties-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .comp-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left, .toolbar-right {
                width: 100%;
                flex-direction: column;
            }

            .comp-select, .comp-input {
                width: 100%;
                min-width: auto;
            }

            .toast-container {
                left: 20px;
                right: 20px;
                bottom: 20px;
            }

            .toast {
                min-width: auto;
            }

            .card-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog" id="confirmationDialog">
        <div class="dialog-content">
            <div class="dialog-title" id="dialogTitle">Confirm Action</div>
            <div class="dialog-message" id="dialogMessage">Are you sure?</div>
            <div class="dialog-actions">
                <button class="dialog-button dialog-button-cancel" onclick="hideConfirmDialog()">Cancel</button>
                <button class="dialog-button dialog-button-confirm" id="dialogConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Comp Set Management Toolbar -->
    <div class="comp-toolbar" id="compToolbar">
        <div class="toolbar-wrapper">
            <div class="toolbar-left">
                <div class="comp-set-name-display">📁 {{COMP_SET_NAME}}</div>
                <div class="selection-counter" id="selectionCounter">0 properties selected</div>
                <button class="comp-button" onclick="showRenameDialog()">🏷️ Rename</button>
                <button class="comp-button comp-button-danger" onclick="showDeleteDialog()">🗑️ Delete Comp Set</button>
            </div>
            <div class="toolbar-right">
                <select class="comp-select" id="otherCompSets">
                    <option value="">Select comp set to add to...</option>
                </select>
                <input type="text" class="comp-input" id="newCompSetName" placeholder="Or enter new comp set name..." style="display:none;">
                <button class="comp-button comp-button-secondary" id="addSelectedBtn" disabled>Add Selected to Comp Set</button>
                <div class="server-status offline" id="serverStatus">Server Offline</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header with Summary Statistics -->
        <div class="header">
            <h1>📊 Comp Set: {{COMP_SET_NAME}}</h1>
            <div class="comp-set-title">Viewing properties in this comp set</div>
            <div class="stats">
                <div class="stat-card">
                    <span class="number" id="totalProperties">{{TOTAL_PROPERTIES}}</span>
                    <span class="label">Total Properties</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="totalUnits">{{TOTAL_UNITS}}</span>
                    <span class="label">Total Units</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="avgYearBuilt">{{AVG_YEAR_BUILT}}</span>
                    <span class="label">Avg Year Built</span>
                </div>
                <div class="stat-card">
                    <span class="number" id="avgOccupancy">{{AVG_OCCUPANCY}}%</span>
                    <span class="label">Avg Occupancy</span>
                </div>
            </div>
        </div>

        <!-- Properties Grid -->
        <div class="properties-grid" id="propertiesGrid">
            <!-- Properties will be inserted here by the recipe -->
            {{PROPERTIES_HTML}}
        </div>
    </div>

    <script>
        // Embedded data
        const COMP_SET_NAME = '{{COMP_SET_NAME}}';
        const PROPERTIES_DATA = {{PROPERTIES_JSON}};

        // Global state
        let serverAvailable = false;
        let existingCompSets = [];
        let selectedProperties = new Set();

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkServerAvailability();
            setupStickyToolbar();
            setupCheckboxListeners();
            setupAddSelectedButton();
        });

        // Add visual effect when toolbar is scrolled
        function setupStickyToolbar() {
            const toolbar = document.getElementById('compToolbar');

            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 0) {
                    toolbar.classList.add('scrolled');
                } else {
                    toolbar.classList.remove('scrolled');
                }
            });
        }

        // Check if server is available
        async function checkServerAvailability() {
            try {
                const response = await fetch('http://localhost:3000/api/comp-sets', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    serverAvailable = true;
                    const compSets = await response.json();
                    existingCompSets = compSets.map(cs => cs.name || cs).filter(name => name !== COMP_SET_NAME);
                    updateServerStatus(true);
                    loadOtherCompSets();
                } else {
                    throw new Error('Server returned status: ' + response.status);
                }
            } catch (error) {
                console.error('Server connection error:', error);
                serverAvailable = false;
                updateServerStatus(false);
                showToast('Server is offline. Please start the server on port 3000 to enable editing features.', 'info');
            }
        }

        // Update server status indicator
        function updateServerStatus(online) {
            const statusEl = document.getElementById('serverStatus');
            const toolbarEl = document.getElementById('compToolbar');

            if (online) {
                statusEl.textContent = '● Server Online';
                statusEl.className = 'server-status online';
                toolbarEl.classList.remove('disabled');
            } else {
                statusEl.textContent = '● Server Offline';
                statusEl.className = 'server-status offline';
                toolbarEl.classList.add('disabled');
            }
        }

        // Load other comp sets into dropdown
        function loadOtherCompSets() {
            const selectEl = document.getElementById('otherCompSets');
            selectEl.innerHTML = '<option value="">Select comp set to add to...</option>';

            existingCompSets.forEach(compSet => {
                const option = document.createElement('option');
                option.value = compSet;
                option.textContent = compSet;
                selectEl.appendChild(option);
            });

            // Add "Create new..." option
            const newOption = document.createElement('option');
            newOption.value = '__new__';
            newOption.textContent = '+ Create new comp set...';
            selectEl.appendChild(newOption);

            // Handle selection change
            selectEl.addEventListener('change', function() {
                const newNameInput = document.getElementById('newCompSetName');
                if (this.value === '__new__') {
                    newNameInput.style.display = 'block';
                    newNameInput.focus();
                } else {
                    newNameInput.style.display = 'none';
                    newNameInput.value = '';
                }
            });
        }

        // Remove property from comp set
        async function removeFromCompSet(propertyId, propertyName) {
            if (!serverAvailable) {
                showToast('Server is offline. Cannot remove property.', 'error');
                return;
            }

            const confirmed = await showConfirmDialog(
                'Remove Property',
                `Are you sure you want to remove "${propertyName}" from "${COMP_SET_NAME}"?`
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`http://localhost:3000/api/comp-sets/${COMP_SET_NAME}/properties/${propertyId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showToast(`Removed "${propertyName}" from comp set`, 'success');

                    // Remove card from DOM
                    const card = document.querySelector(`[data-property-id="${propertyId}"]`);
                    if (card) {
                        card.style.opacity = '0';
                        setTimeout(() => card.remove(), 300);
                    }

                    // Update stats
                    updateStats();
                } else {
                    throw new Error('Failed to remove property');
                }
            } catch (error) {
                console.error('Error removing property:', error);
                showToast('Failed to remove property. Please try again.', 'error');
            }
        }

        // Setup checkbox listeners
        function setupCheckboxListeners() {
            const checkboxes = document.querySelectorAll('.property-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }

        // Handle checkbox changes
        function handleCheckboxChange(e) {
            const propertyId = e.target.dataset.propertyId;
            const card = document.querySelector(`.property-card[data-property-id="${propertyId}"]`);

            if (e.target.checked) {
                selectedProperties.add(propertyId);
                card.classList.add('selected');
            } else {
                selectedProperties.delete(propertyId);
                card.classList.remove('selected');
            }

            updateSelectionCounter();
            updateAddSelectedButton();
        }

        // Update selection counter
        function updateSelectionCounter() {
            const count = selectedProperties.size;
            const counterEl = document.getElementById('selectionCounter');
            counterEl.textContent = `${count} ${count === 1 ? 'property' : 'properties'} selected`;
        }

        // Update add selected button state
        function updateAddSelectedButton() {
            const addBtn = document.getElementById('addSelectedBtn');
            const hasSelection = selectedProperties.size > 0;
            const selectEl = document.getElementById('otherCompSets');
            const newNameInput = document.getElementById('newCompSetName');
            const hasTarget = selectEl.value !== '' || newNameInput.value.trim() !== '';

            addBtn.disabled = !serverAvailable || !hasSelection || !hasTarget;
        }

        // Setup add selected button
        function setupAddSelectedButton() {
            const addBtn = document.getElementById('addSelectedBtn');
            addBtn.addEventListener('click', handleBulkAddToCompSet);

            // Update button state when comp set selection changes
            const selectEl = document.getElementById('otherCompSets');
            const newNameInput = document.getElementById('newCompSetName');

            selectEl.addEventListener('change', function() {
                if (this.value === '__new__') {
                    newNameInput.style.display = 'block';
                    newNameInput.focus();
                } else {
                    newNameInput.style.display = 'none';
                    newNameInput.value = '';
                }
                updateAddSelectedButton();
            });

            newNameInput.addEventListener('input', updateAddSelectedButton);
        }

        // Handle bulk add to comp set
        async function handleBulkAddToCompSet() {
            if (!serverAvailable) {
                showToast('Server is offline. Cannot add to comp set.', 'error');
                return;
            }

            if (selectedProperties.size === 0) {
                showToast('Please select at least one property.', 'error');
                return;
            }

            const selectEl = document.getElementById('otherCompSets');
            const newNameInput = document.getElementById('newCompSetName');

            let targetCompSet = selectEl.value;

            if (targetCompSet === '__new__') {
                targetCompSet = newNameInput.value.trim();
                if (!targetCompSet) {
                    showToast('Please enter a comp set name.', 'error');
                    return;
                }
            }

            if (!targetCompSet || targetCompSet === '') {
                showToast('Please select a comp set.', 'error');
                return;
            }

            // Gather selected properties data
            const properties = Array.from(selectedProperties).map(propertyId => {
                const propertyData = PROPERTIES_DATA.find(p => p.property_id === propertyId);
                if (propertyData) {
                    return {
                        id: propertyId,
                        name: propertyData.name || propertyData.property_name,
                        address: propertyData.address?.full_address || propertyData.address || 'N/A'
                    };
                }
                return null;
            }).filter(p => p !== null);

            try {
                const response = await fetch('http://localhost:3000/api/save-comp-set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: targetCompSet,
                        properties: properties
                    })
                });

                if (response.ok) {
                    showToast(`Added ${properties.length} ${properties.length === 1 ? 'property' : 'properties'} to "${targetCompSet}"`, 'success');

                    // Clear selections
                    selectedProperties.clear();
                    document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = false);
                    document.querySelectorAll('.property-card').forEach(card => card.classList.remove('selected'));
                    updateSelectionCounter();
                    updateAddSelectedButton();

                    // Refresh comp sets list if new
                    if (!existingCompSets.includes(targetCompSet)) {
                        await checkServerAvailability();
                    }

                    // Reset form
                    selectEl.value = '';
                    newNameInput.value = '';
                    newNameInput.style.display = 'none';
                } else {
                    throw new Error('Failed to add to comp set');
                }
            } catch (error) {
                console.error('Error adding to comp set:', error);
                showToast('Failed to add to comp set. Please try again.', 'error');
            }
        }

        // Show rename dialog
        function showRenameDialog() {
            if (!serverAvailable) {
                showToast('Server is offline. Cannot rename comp set.', 'error');
                return;
            }

            const newName = prompt(`Rename comp set "${COMP_SET_NAME}" to:`, COMP_SET_NAME);

            if (!newName || newName === COMP_SET_NAME) return;

            renameCompSet(newName);
        }

        // Rename comp set
        async function renameCompSet(newName) {
            try {
                const response = await fetch(`http://localhost:3000/api/comp-sets/${COMP_SET_NAME}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newName })
                });

                if (response.ok) {
                    showToast(`Comp set renamed to "${newName}"`, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error('Failed to rename comp set');
                }
            } catch (error) {
                console.error('Error renaming comp set:', error);
                showToast('Failed to rename comp set. Please try again.', 'error');
            }
        }

        // Show delete dialog
        async function showDeleteDialog() {
            if (!serverAvailable) {
                showToast('Server is offline. Cannot delete comp set.', 'error');
                return;
            }

            const confirmed = await showConfirmDialog(
                'Delete Comp Set',
                `Are you sure you want to delete the entire "${COMP_SET_NAME}" comp set? This action cannot be undone.`
            );

            if (confirmed) {
                deleteCompSet();
            }
        }

        // Delete comp set
        async function deleteCompSet() {
            try {
                const response = await fetch(`http://localhost:3000/api/comp-sets/${COMP_SET_NAME}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showToast('Comp set deleted successfully', 'success');
                    setTimeout(() => {
                        window.close();
                    }, 1500);
                } else {
                    throw new Error('Failed to delete comp set');
                }
            } catch (error) {
                console.error('Error deleting comp set:', error);
                showToast('Failed to delete comp set. Please try again.', 'error');
            }
        }

        // Update statistics after removing properties
        function updateStats() {
            const remainingCards = document.querySelectorAll('.property-card');
            document.getElementById('totalProperties').textContent = remainingCards.length;
        }

        // Show confirmation dialog
        function showConfirmDialog(title, message) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirmationDialog');
                const titleEl = document.getElementById('dialogTitle');
                const messageEl = document.getElementById('dialogMessage');
                const confirmBtn = document.getElementById('dialogConfirmBtn');

                titleEl.textContent = title;
                messageEl.textContent = message;

                dialog.classList.add('show');

                const handleConfirm = () => {
                    dialog.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    resolve(true);
                };

                confirmBtn.onclick = handleConfirm;
            });
        }

        // Hide confirmation dialog
        function hideConfirmDialog() {
            const dialog = document.getElementById('confirmationDialog');
            dialog.classList.remove('show');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';

            toast.innerHTML = `
                <span style="font-size: 1.2em;">${icon}</span>
                <div class="toast-message">${message}</div>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
