<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparable Properties Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .property-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .property-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .property-name {
            color: #2d3748;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .property-address {
            color: #718096;
            font-size: 0.95em;
        }

        .property-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .badge-multifamily { background: #9f7aea; color: white; }
        .badge-office { background: #48bb78; color: white; }
        .badge-retail { background: #ed8936; color: white; }
        .badge-industrial { background: #4299e1; color: white; }
        .badge-mixed { background: #ed64a6; color: white; }

        .property-details {
            margin: 20px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-label {
            color: #4a5568;
            font-weight: 600;
        }

        .detail-value {
            color: #2d3748;
        }

        .occupancy-high { color: #38a169; font-weight: bold; }
        .occupancy-medium { color: #ecc94b; font-weight: bold; }
        .occupancy-low { color: #e53e3e; font-weight: bold; }

        .amenities {
            margin: 15px 0;
        }

        .amenities-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .amenities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .amenity-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .units-section {
            margin-top: 20px;
        }

        .units-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .units-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .units-table th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
        }

        .units-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .units-table tr:nth-child(even) {
            background: #f7fafc;
        }

        .units-table tr:hover {
            background: #edf2f7;
        }

        .rent-highlight {
            color: #667eea;
            font-weight: 600;
        }

        .source-document {
            margin-top: 15px;
            padding: 10px;
            background: #f7fafc;
            border-left: 4px solid #667eea;
            font-size: 0.85em;
            color: #4a5568;
        }

        .notes {
            margin-top: 15px;
            padding: 10px;
            background: #fffbeb;
            border-left: 4px solid #ecc94b;
            font-size: 0.9em;
            color: #744210;
        }

        /* Comp Set Management Toolbar */
        .comp-toolbar {
            background: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .comp-toolbar.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .comp-toolbar.scrolled {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Inner wrapper for toolbar content to respect container width */
        .toolbar-wrapper {
            max-width: calc(1400px + 40px);
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .toolbar-left {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            flex: 1;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .selection-counter {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .comp-select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            color: #2d3748;
            cursor: pointer;
            min-width: 200px;
        }

        .comp-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .comp-input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            min-width: 250px;
        }

        .comp-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .comp-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .comp-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .comp-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .comp-button-secondary {
            background: #48bb78;
        }

        .server-status {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .server-status.online {
            background: #c6f6d5;
            color: #22543d;
        }

        .server-status.offline {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Property Card Checkbox */
        .property-checkbox {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .property-card {
            position: relative;
        }

        .property-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }


        /* Saved Indicator Badge */
        .saved-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #48bb78;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .property-card.saved .saved-badge {
            display: flex;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #e53e3e;
        }

        .toast.info {
            border-left: 4px solid #4299e1;
        }

        .toast-message {
            flex: 1;
            color: #2d3748;
            font-size: 0.95em;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100px);
                opacity: 0;
            }
        }

        .toast.removing {
            animation: slideOut 0.3s ease;
        }

        @media (max-width: 768px) {
            .properties-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .comp-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left, .toolbar-right {
                width: 100%;
                flex-direction: column;
            }

            .comp-select, .comp-input {
                width: 100%;
                min-width: auto;
            }

            .toast-container {
                left: 20px;
                right: 20px;
                bottom: 20px;
            }

            .toast {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Comp Set Management Toolbar -->
    <div class="comp-toolbar" id="compToolbar">
        <div class="toolbar-wrapper">
                <div class="toolbar-left">
                    <div class="selection-counter" id="selectionCounter">0 properties selected</div>
                    <select class="comp-select" id="existingCompSets">
                        <option value="">Select existing comp set...</option>
                    </select>
                    <input type="text" class="comp-input" id="newCompSetName" placeholder="Or enter new comp set name...">
                </div>
                <div class="toolbar-right">
                    <div class="server-status offline" id="serverStatus">Server Offline</div>
                    <button class="comp-button" id="addSelectedBtn" disabled>Add Selected to Comp Set</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header with Summary Statistics -->
        <div class="header">
            <h1>📊 Comparable Properties Report</h1>
            <div class="stats">
                <div class="stat-card">
                    <span class="number">14</span>
                    <span class="label">Total Properties</span>
                </div>
                <div class="stat-card">
                    <span class="number">38</span>
                    <span class="label">Total Units</span>
                </div>
                <div class="stat-card">
                    <span class="number">1</span>
                    <span class="label">Documents Processed</span>
                </div>
                <div class="stat-card">
                    <span class="number">5.5%</span>
                    <span class="label">Avg Vacancy</span>
                </div>
            </div>
        </div>

        <!-- Properties Grid -->
        <div class="properties-grid">
            <!-- Example Property Card 1 -->
            <div class="property-card" data-property-id="property-1">
                <input type="checkbox" class="property-checkbox" data-property-id="property-1">
                <div class="saved-badge">✓ Saved</div>
                <div class="property-header">
                    <div class="property-name">The Baldwin - St. Paul Square</div>
                    <div class="property-address">239 Center St, San Antonio, TX 78202</div>
                    <span class="property-type-badge badge-multifamily">Multifamily</span>
                </div>

                <div class="property-details">
                    <div class="detail-row">
                        <span class="detail-label">Year Built:</span>
                        <span class="detail-value">2018</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Units:</span>
                        <span class="detail-value">271</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Occupancy Rate:</span>
                        <span class="detail-value occupancy-high">94.1%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value">2.8 mi</span>
                    </div>
                </div>

                <div class="amenities">
                    <div class="amenities-title">Amenities</div>
                    <div class="amenities-list">
                        <span class="amenity-tag">Amazon Hub Locker</span>
                        <span class="amenity-tag">Multiple Lounges</span>
                        <span class="amenity-tag">Pet Friendly</span>
                        <span class="amenity-tag">Pool</span>
                    </div>
                </div>

                <div class="units-section">
                    <div class="units-title">Unit Mix</div>
                    <table class="units-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Sq Ft</th>
                                <th>Rent</th>
                                <th>$/SF</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1BR</td>
                                <td>646</td>
                                <td class="rent-highlight">$1,091</td>
                                <td>$1.69</td>
                            </tr>
                            <tr>
                                <td>2BR</td>
                                <td>1,213</td>
                                <td class="rent-highlight">$1,811</td>
                                <td>$1.49</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="source-document">
                    📄 Source: Offering Memorandum (OM) - 207 Omaha St.pdf
                </div>

                <div class="notes">
                    💡 Neighborhood: Near East Side; Vacancy: 5.9%
                </div>
            </div>

            <!-- Example Property Card 2 -->
            <div class="property-card" data-property-id="property-2">
                <input type="checkbox" class="property-checkbox" data-property-id="property-2">
                <div class="saved-badge">✓ Saved</div>
                <div class="property-header">
                    <div class="property-name">Augusta Flats</div>
                    <div class="property-address">714 McCullough Ave, San Antonio, TX 78215</div>
                    <span class="property-type-badge badge-multifamily">Multifamily</span>
                </div>

                <div class="property-details">
                    <div class="detail-row">
                        <span class="detail-label">Year Built:</span>
                        <span class="detail-value">2021</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Units:</span>
                        <span class="detail-value">260</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Occupancy Rate:</span>
                        <span class="detail-value occupancy-high">96.1%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value">3.4 mi</span>
                    </div>
                </div>

                <div class="amenities">
                    <div class="amenities-title">Amenities</div>
                    <div class="amenities-list">
                        <span class="amenity-tag">Sky lounge</span>
                    </div>
                </div>

                <div class="units-section">
                    <div class="units-title">Unit Mix</div>
                    <table class="units-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Sq Ft</th>
                                <th>Rent</th>
                                <th>$/SF</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Studio</td>
                                <td>606</td>
                                <td class="rent-highlight">$1,582</td>
                                <td>$2.61</td>
                            </tr>
                            <tr>
                                <td>1BR</td>
                                <td>743</td>
                                <td class="rent-highlight">$1,749</td>
                                <td>$2.35</td>
                            </tr>
                            <tr>
                                <td>2BR</td>
                                <td>1,068</td>
                                <td class="rent-highlight">$2,265</td>
                                <td>$2.12</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="source-document">
                    📄 Source: Offering Memorandum (OM) - 207 Omaha St.pdf
                </div>

                <div class="notes">
                    💡 Neighborhood: North Downtown; Vacancy: 3.9%
                </div>
            </div>

            <!-- Additional cards would follow the same pattern -->
        </div>
    </div>

    <script>
        // Global state
        let serverAvailable = false;
        let existingCompSets = [];
        let selectedProperties = new Set();
        let savedProperties = new Set();

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkServerAvailability();
            setupEventListeners();
            setupStickyToolbar();
        });

        // Add visual effect when toolbar is scrolled
        function setupStickyToolbar() {
            const toolbar = document.getElementById('compToolbar');
            const toolbarOriginalTop = toolbar.offsetTop;

            window.addEventListener('scroll', function() {
                if (window.pageYOffset > toolbarOriginalTop) {
                    toolbar.classList.add('scrolled');
                } else {
                    toolbar.classList.remove('scrolled');
                }
            });
        }

        // Check if server is available
        async function checkServerAvailability() {
            try {
                console.log('Checking server availability at http://localhost:3000/api/comp-sets...');
                const response = await fetch('http://localhost:3000/api/comp-sets', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log('Server response status:', response.status);

                if (response.ok) {
                    serverAvailable = true;
                    const compSets = await response.json();
                    console.log('Received comp sets:', compSets);
                    // Server returns array of objects with 'name' property
                    existingCompSets = compSets.map(cs => cs.name || cs);
                    updateServerStatus(true);
                    loadExistingCompSets();
                    showToast('Connected to server successfully!', 'success');
                } else {
                    throw new Error('Server returned status: ' + response.status);
                }
            } catch (error) {
                console.error('Server connection error:', error);
                serverAvailable = false;
                updateServerStatus(false);
                showToast('Server is offline. Please start the server on port 3000.', 'info');
            }
        }

        // Update server status indicator
        function updateServerStatus(online) {
            const statusEl = document.getElementById('serverStatus');
            const toolbarEl = document.getElementById('compToolbar');

            if (online) {
                statusEl.textContent = '● Server Online';
                statusEl.className = 'server-status online';
                toolbarEl.classList.remove('disabled');
            } else {
                statusEl.textContent = '● Server Offline';
                statusEl.className = 'server-status offline';
                toolbarEl.classList.add('disabled');
            }
        }

        // Load existing comp sets into dropdown
        function loadExistingCompSets() {
            const selectEl = document.getElementById('existingCompSets');

            // Clear existing options except the first one
            selectEl.innerHTML = '<option value="">Select existing comp set...</option>';

            // Add comp sets to dropdown
            existingCompSets.forEach(compSet => {
                const option = document.createElement('option');
                option.value = compSet;
                option.textContent = compSet;
                selectEl.appendChild(option);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Checkbox listeners
            const checkboxes = document.querySelectorAll('.property-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });

            // Bulk add button listener
            const addSelectedBtn = document.getElementById('addSelectedBtn');
            addSelectedBtn.addEventListener('click', handleBulkAdd);

            // Clear new comp set name when existing is selected
            const existingSelect = document.getElementById('existingCompSets');
            existingSelect.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('newCompSetName').value = '';
                }
            });

            // Clear existing selection when typing new name
            const newNameInput = document.getElementById('newCompSetName');
            newNameInput.addEventListener('input', function() {
                if (this.value) {
                    document.getElementById('existingCompSets').value = '';
                }
            });
        }

        // Handle checkbox changes
        function handleCheckboxChange(e) {
            const propertyId = e.target.dataset.propertyId;
            const card = document.querySelector(`.property-card[data-property-id="${propertyId}"]`);

            if (e.target.checked) {
                selectedProperties.add(propertyId);
                card.classList.add('selected');
            } else {
                selectedProperties.delete(propertyId);
                card.classList.remove('selected');
            }

            updateSelectionCounter();
            updateAddButton();
        }

        // Update selection counter
        function updateSelectionCounter() {
            const count = selectedProperties.size;
            const counterEl = document.getElementById('selectionCounter');
            counterEl.textContent = `${count} ${count === 1 ? 'property' : 'properties'} selected`;
        }

        // Update add button state
        function updateAddButton() {
            const addBtn = document.getElementById('addSelectedBtn');
            const hasSelection = selectedProperties.size > 0;
            const hasCompSetName = getCompSetName() !== null;

            addBtn.disabled = !serverAvailable || !hasSelection || !hasCompSetName;
        }

        // Get comp set name from either dropdown or input
        function getCompSetName() {
            const existingName = document.getElementById('existingCompSets').value;
            const newName = document.getElementById('newCompSetName').value.trim();

            if (existingName) return existingName;
            if (newName) return newName;
            return null;
        }

        // Handle bulk add
        async function handleBulkAdd() {
            if (!serverAvailable) {
                showToast('Server is offline. Cannot save to comp set.', 'error');
                return;
            }

            const compSetName = getCompSetName();

            if (!compSetName) {
                showToast('Please select or enter a comp set name.', 'error');
                return;
            }

            if (selectedProperties.size === 0) {
                showToast('Please select at least one property.', 'error');
                return;
            }

            const properties = Array.from(selectedProperties).map(id => getPropertyData(id));
            await saveToCompSet(compSetName, properties);
        }

        // Get property data from DOM
        function getPropertyData(propertyId) {
            const card = document.querySelector(`.property-card[data-property-id="${propertyId}"]`);

            return {
                id: propertyId,
                name: card.querySelector('.property-name').textContent,
                address: card.querySelector('.property-address').textContent,
                // Add more data as needed from the card
            };
        }

        // Save properties to comp set
        async function saveToCompSet(compSetName, properties) {
            try {
                const response = await fetch('http://localhost:3000/api/save-comp-set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: compSetName,
                        properties: properties
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Mark properties as saved
                    properties.forEach(prop => {
                        savedProperties.add(prop.id);
                        const card = document.querySelector(`.property-card[data-property-id="${prop.id}"]`);
                        card.classList.add('saved');
                    });

                    showToast(`Successfully added ${properties.length} ${properties.length === 1 ? 'property' : 'properties'} to "${compSetName}"`, 'success');

                    // Refresh comp sets list if it was a new comp set
                    if (!existingCompSets.includes(compSetName)) {
                        await checkServerAvailability();
                    }
                } else {
                    throw new Error('Failed to save comp set');
                }
            } catch (error) {
                console.error('Error saving comp set:', error);
                showToast('Failed to save to comp set. Please try again.', 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';

            toast.innerHTML = `
                <span style="font-size: 1.2em;">${icon}</span>
                <div class="toast-message">${message}</div>
            `;

            toastContainer.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }

        // Monitor input changes to enable/disable add button
        document.getElementById('existingCompSets').addEventListener('change', updateAddButton);
        document.getElementById('newCompSetName').addEventListener('input', updateAddButton);
    </script>
</body>
</html>
